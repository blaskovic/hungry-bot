#!/bin/bash


# Args
CHANNEL=${CHANNEL:-"##pivo"}
SERVER=${SERVER:-"irc.freenode.org"}
NICK=${NICK:-"cobuduzrat"}
IRCDIR=${IRCDIR:-"ircdir"}
TMPFILE=$(mktemp)
WEBSERVER="http://blaskovic.sk:8099/?menu="

trap "echo '/quit' > $IRCDIR/$SERVER/in"  SIGINT

# ii
set -x
make -C ii
rm -rfv "$IRCDIR/$SERVER"
set +x
./ii/ii -i "$IRCDIR" -s "$SERVER" -n "$NICK" &
sleep 5
echo "/j $CHANNEL" > "$IRCDIR/$SERVER/in"

sleep 2

# Parser
echo > "$IRCDIR/$SERVER/$CHANNEL/out"
tail -f "$IRCDIR/$SERVER/$CHANNEL/out" | \
    while read -r date time nick mesg; do
        nick="${nick#<}"
        nick="${nick%>}"
        echo "$mesg" | grep -q -e ^menu -e "^$NICK:"
        if [ $? -eq 0 ]
        then
            # We want menu! # strip whitespace needed!
            menu=$(echo "$mesg" | sed "s/menu //" | sed "s/$NICK: //" | sed -e 's/[^-a-zA-Z0-9]//g')

            out=$(curl "${WEBSERVER}$menu")
            echo "$out" 
            
            i=0
            while read -r line; do
                ((i++))
                if [ $i -gt 11 ] && [[ $SERVER == *"freenode"* ]]; then # freenode anti-anti-spam
                    sleep 2
                fi
                echo "$line" > "$IRCDIR/$SERVER/$CHANNEL/in"
            done <<< "$out"
        fi
    done


# End
rm $TMPFILE
