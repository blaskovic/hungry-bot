#!/bin/bash
echo "Na Purkynce"
TODAY=$(LC=C date "+%A")
BEG_PATTERN="<br \/>"
END_PATTERN="<end>"

case "$TODAY" in
Monday)
    BEG_PATTERN="<pre>"
    TODAY_CZ="PONDĚLÍ"
    ;;
Tuesday)
    TODAY_CZ="ÚTERÝ"
    ;;
Wednesday)
    TODAY_CZ="STŘEDA"
    ;;
Thursday)
    TODAY_CZ="ČTVRTEK"
    ;;
Friday)
    END_PATTERN="<\/pre>"
    TODAY_CZ="PÁTEK"
    ;;
*)
    echo "Dnes je $TODAY, neni menu alebo je nieco spatne."
    rm -rf "$tmp"
    exit 0
esac

#PATTERN="/$BEG_PATTERN$TODAY_CZ/,/$END_PATTERN/"
#curl -s http://www.napurkynce.cz/denni-menu/ | sed 's/<br \/><br \/>/<end>\n<br \/>/g' | awk "$PATTERN" | sed 's/^<br \/>//' | sed 's/<br \/>/\n/g' | sed 's/<[^>]*>//g'

curl -s http://www.napurkynce.cz/denni-menu/ | awk -v day=$TODAY_CZ '
BEGIN {
    idx = 0;
    lf = 0;

    # Template 1
    t["template1"]["begrx"] = "<div>("day":.+?)</div>";
    t["template1"]["midrx"] = "<div>(<span>)?([a-z]\\).[^<]+)(</span>)?</div>";
    t["template1"]["endrx"] = "(<div>&nbsp;|<pre>.*</pre>)";
    t["template1"]["begidx"] = 1;
    t["template1"]["mididx"] = 2;

    # Template 2
    t["template2"]["RS"] ="<br />";
    t["template2"]["begrx"] = "(<pre>)?("day":.+?)";
    t["template2"]["midrx"] = "^([a-z]\\).[^<]+)";
    t["template2"]["endrx"] = "^$"
    t["template2"]["begidx"] = 2;
    t["template2"]["mididx"] = 1;

    # Selected template
    ctp = "template2";

    if(!(ctp in t)) {
        print "Invalid template: " ctp;
        exit 1;
    }

    if("RS" in t[ctp])
        RS = t[ctp]["RS"];
}
match($0, t[ctp]["begrx"], m) {
    res[idx++] = m[t[ctp]["begidx"]];
    lf = 1;
}
match($0, t[ctp]["midrx"], m) {
    res[idx++] = m[t[ctp]["mididx"]];
}
match($0, t[ctp]["endrx"]) {
    if(lf == 1) {
        for(i in res) print res[i];
        exit 0;
    }

    delete res;
    lf = 0;
    idx = 0;
}'
